<!DOCTYPE html>
{% macro model_select(id, default='haiku', include_gemini=true) -%}
<select id="{{ id }}" class="model-select-inline">
    <option value="claude-haiku-4-5-20251001" {{ 'selected' if default == 'haiku' }}>Haiku</option>
    <option value="claude-sonnet-4-5-20250929" {{ 'selected' if default == 'sonnet' }}>Sonnet</option>
    <option value="claude-opus-4-6" {{ 'selected' if default == 'opus' }}>Opus</option>
    {% if include_gemini -%}
    <option disabled>──────────</option>
    <option value="gemini-2.0-flash">Gemini Flash</option>
    <option value="gemini-2.5-pro">Gemini Pro</option>
    {%- endif %}
</select>
{%- endmacro %}
<html lang="en" data-theme="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Research Taxonomy Library</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Newsreader:ital,opsz,wght@0,6..72,200..800;1,6..72,200..800&family=Noto+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css">
    <!-- Tabulator CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tabulator-tables@6.3.1/dist/css/tabulator_midnight.min.css">
    <!-- Tippy.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/dist/tippy.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/themes/light-border.css">
    <!-- Notyf CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3.10.0/notyf.min.css">
    <!-- Driver.js CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.css">
    <!-- Tagify CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@yaireo/tagify@4.31.3/dist/tagify.css">

    <!-- Existing libraries -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@15.0.4/marked.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@11/dist/mermaid.min.js" defer></script>

    <!-- Data Visualization -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js" defer></script>
    <!-- Network/Graph -->
    <script src="https://cdn.jsdelivr.net/npm/cytoscape@3.30.4/dist/cytoscape.min.js" defer></script>
    <!-- Geographic Maps -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js" defer></script>
    <!-- Data Table -->
    <script src="https://cdn.jsdelivr.net/npm/tabulator-tables@6.3.1/dist/js/tabulator.min.js" defer></script>
    <!-- Drag and Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.6/Sortable.min.js" defer></script>
    <!-- Search -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js" defer></script>
    <!-- PDF Generation -->
    <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.18/build/pdfmake.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/pdfmake@0.2.18/build/vfs_fonts.js" defer></script>
    <!-- Excel Export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js" defer></script>
    <!-- File Download -->
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js" defer></script>
    <!-- Security -->
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.2.4/dist/purify.min.js" defer></script>
    <!-- Date Formatting -->
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/dayjs.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.13/plugin/relativeTime.js" defer></script>
    <!-- Tooltips -->
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/tippy.js@6.3.7/dist/tippy-bundle.umd.min.js" defer></script>
    <!-- Notifications -->
    <script src="https://cdn.jsdelivr.net/npm/notyf@3.10.0/notyf.min.js" defer></script>
    <!-- Product Tour -->
    <script src="https://cdn.jsdelivr.net/npm/driver.js@1.3.1/dist/driver.js.iife.js" defer></script>
    <!-- Tags -->
    <script src="https://cdn.jsdelivr.net/npm/@yaireo/tagify@4.31.3/dist/tagify.min.js" defer></script>
    <!-- Animation -->
    <script src="https://cdn.jsdelivr.net/npm/motion@11.16.0/dist/motion.js" defer></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js" defer></script>
    <!-- Keyboard Shortcuts -->
    <script src="https://cdn.jsdelivr.net/npm/hotkeys-js@3.13.9/dist/hotkeys.min.js" defer></script>
</head>
<body>
    <a href="#mainApp" class="skip-link">Skip to main content</a>

    <!-- Connection loss banner -->
    <div id="connectionBanner" class="connection-banner hidden" role="alert">
        <span class="connection-banner-icon">&#9888;</span>
        <span>Connection lost — retrying...</span>
        <button onclick="location.reload()" class="connection-banner-btn">Reload</button>
    </div>

    <!-- Keyboard shortcuts overlay -->
    <div id="shortcutsOverlay" class="shortcuts-overlay hidden" onclick="if(event.target===this)toggleShortcutsOverlay()">
        <div class="shortcuts-panel">
            <div class="shortcuts-header">
                <h2>Keyboard Shortcuts</h2>
                <button onclick="toggleShortcutsOverlay()" aria-label="Close shortcuts">&times;</button>
            </div>
            <div class="shortcuts-grid">
                <div class="shortcut-section">
                    <h3>Navigation</h3>
                    <div class="shortcut-row"><kbd>1</kbd>–<kbd>6</kbd> <span>Switch tabs</span></div>
                    <div class="shortcut-row"><kbd>/</kbd> <span>Focus search</span></div>
                    <div class="shortcut-row"><kbd>j</kbd> / <kbd>k</kbd> <span>Navigate rows</span></div>
                    <div class="shortcut-row"><kbd>Enter</kbd> <span>Open selected</span></div>
                    <div class="shortcut-row"><kbd>Esc</kbd> <span>Close panel/modal</span></div>
                </div>
                <div class="shortcut-section">
                    <h3>Actions</h3>
                    <div class="shortcut-row"><kbd>&#8984;K</kbd> <span>Quick search</span></div>
                    <div class="shortcut-row"><kbd>&#8984;E</kbd> <span>Export Excel</span></div>
                    <div class="shortcut-row"><kbd>&#8984;&#8679;P</kbd> <span>Export PDF</span></div>
                    <div class="shortcut-row"><kbd>?</kbd> <span>This overlay</span></div>
                </div>
                <div class="shortcut-section">
                    <h3>Views</h3>
                    <div class="shortcut-row"><kbd>g</kbd> <span>Geographic map (in Map tab)</span></div>
                    <div class="shortcut-row"><kbd>t</kbd> <span>Graph view (in Taxonomy tab)</span></div>
                </div>
            </div>
        </div>
    </div>

    <div class="container" role="main">
        <!-- ========== Project Selection Screen ========== -->
        <div id="projectSelection">
            <header>
                <div class="flex-between">
                    <div>
                        <h1>Research Taxonomy Library</h1>
                        <p class="header-subtitle">Select a research project or create a new one.</p>
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode (D)" aria-label="Toggle dark mode">&#9789;</button>
                </div>
            </header>
            <div id="projectGrid" class="project-grid" role="list" aria-label="Research projects"></div>
        </div>

        <!-- ========== New Project Form ========== -->
        <div id="newProjectForm" class="hidden">
            <header>
                <div class="header-with-back">
                    <button class="back-btn" onclick="showProjectSelection()">&larr;</button>
                    <h1>New Research Project</h1>
                </div>
            </header>
            <form onsubmit="createProject(event)">
                <div class="new-project-form">
                    <div class="form-group full-width">
                        <label for="npName">Project Name *</label>
                        <input type="text" id="npName" required placeholder="e.g. Aesthetic Design Connections">
                    </div>
                    <div class="form-group full-width">
                        <label for="npPurpose">Purpose *</label>
                        <textarea id="npPurpose" rows="3" required placeholder="What is this research for? What question are you trying to answer?"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="npOutcome">Expected Outcome</label>
                        <textarea id="npOutcome" rows="2" placeholder="What deliverable will this produce? e.g. FigJam board, market map, report"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="npCategories">Starting Categories *</label>
                        <textarea id="npCategories" rows="3" required placeholder="Enter category names, one per line. These seed the initial taxonomy structure."></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="npLinks">Example Links</label>
                        <textarea id="npLinks" rows="4" placeholder="Paste example URLs that represent the type of companies/products you're researching (one per line)"></textarea>
                    </div>
                    <div class="form-group full-width">
                        <label for="npKeywords">Market Keywords</label>
                        <input type="text" id="npKeywords" placeholder="Comma-separated keywords for triage relevance. e.g. design, aesthetic, visual, art, creative">
                    </div>
                    <div class="form-group full-width">
                        <label for="npDescription">Description</label>
                        <textarea id="npDescription" rows="3" placeholder="Any additional context or notes about this research project"></textarea>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="primary-btn">Create Project</button>
                        <button type="button" class="btn" onclick="showProjectSelection()">Cancel</button>
                    </div>
                </div>
            </form>
        </div>

        <!-- ========== Main App (shown after project selection) ========== -->
        <div id="mainApp" class="hidden">
            <header>
                <div class="flex-between">
                    <div class="header-with-back">
                        <button class="back-btn" onclick="switchProject()">&larr;</button>
                        <div>
                            <h1 id="projectTitle">Project</h1>
                            <div class="stats-bar">
                                <span id="statCompanies">0 companies</span>
                                <span id="statCategories">0 categories</span>
                                <span id="statUpdated">Never updated</span>
                            </div>
                        </div>
                    </div>
                    <div class="flex-center-gap">
                        <button class="notification-bell" onclick="toggleNotificationPanel()" title="Notifications" aria-label="Toggle notifications" aria-expanded="false" aria-controls="notificationPanel">
                            <span class="bell-icon" aria-hidden="true">&#128276;</span>
                            <span class="bell-badge hidden" id="bellBadge" aria-live="polite">0</span>
                        </button>
                        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark mode (D)" aria-label="Toggle dark mode">&#9789;</button>
                    </div>
                </div>
            </header>

            <!-- Notification Panel -->
            <div id="notificationPanel" class="notification-panel hidden">
                <div class="notif-panel-header">
                    <strong>Recent Activity</strong>
                    <button class="close-btn" onclick="toggleNotificationPanel()">&times;</button>
                </div>
                <div id="notifPanelContent" class="notif-panel-content">
                    <p class="hint-text">No recent activity.</p>
                </div>
            </div>

            <nav class="tabs" role="tablist" aria-label="Main navigation">
                <button class="tab active" role="tab" aria-selected="true" aria-controls="tab-companies" onclick="showTab('companies')">Companies</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-taxonomy" onclick="showTab('taxonomy')">Taxonomy</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-map" onclick="showTab('map')">Map</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-reports" onclick="showTab('reports')">Reports</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-process" onclick="showTab('process')">Process</button>
                <button class="tab" role="tab" aria-selected="false" aria-controls="tab-export" onclick="showTab('export')">Export</button>
            </nav>

            <!-- Companies Tab -->
            <section id="tab-companies" class="tab-content active" role="tabpanel" aria-label="Companies">
                <div class="controls">
                    <input type="text" id="searchInput" placeholder="Search companies... (/ to focus)" oninput="debounceSearch()">
                    <select id="categoryFilter" onchange="addFilterFromSelect('category')">
                        <option value="">+ Category</option>
                    </select>
                    <select id="tagFilter" onchange="addFilterFromSelect('tag')">
                        <option value="">+ Tag</option>
                    </select>
                    <select id="geoFilter" onchange="addFilterFromSelect('geography')">
                        <option value="">+ Geography</option>
                    </select>
                    <select id="stageFilter" onchange="addFilterFromSelect('funding_stage')">
                        <option value="">+ Stage</option>
                    </select>
                    <select id="relationshipFilter" class="filter-select" onchange="loadCompanies()">
                        <option value="">Relationship</option>
                        <option value="any">Any flagged</option>
                        <option value="watching">Watching</option>
                        <option value="to_reach_out">To Reach Out</option>
                        <option value="in_conversation">In Conversation</option>
                        <option value="met">Met</option>
                        <option value="partner">Partner</option>
                        <option value="not_relevant">Not Relevant</option>
                    </select>
                    <label class="filter-checkbox"><input type="checkbox" id="starredFilter" onchange="loadCompanies()"> Starred</label>
                    <label class="filter-checkbox"><input type="checkbox" id="enrichmentFilter" onchange="loadCompanies()"> Needs enrichment</label>
                    <button class="filter-action-btn" onclick="openTagManager()" title="Manage tags">Tags</button>
                </div>

                <!-- Active filters as chips -->
                <div id="activeFilters" class="filter-chips-bar hidden"></div>

                <!-- Saved views bar -->
                <div class="saved-views-bar">
                    <select id="savedViewSelect" onchange="loadSavedView()">
                        <option value="">Saved views...</option>
                    </select>
                    <button class="filter-action-btn" onclick="saveCurrentView()" title="Save current filters">Save view</button>
                </div>

                <table id="companyTable">
                    <thead>
                        <tr>
                            <th class="sort-header" data-sort="starred" style="width:3%"></th>
                            <th class="sort-header" data-sort="name">Name</th>
                            <th class="sort-header" data-sort="category">Category</th>
                            <th>What</th>
                            <th>Target</th>
                            <th class="sort-header" data-sort="geography">Geo</th>
                            <th>Sources</th>
                            <th>Tags</th>
                            <th class="sort-header" data-sort="confidence">Conf.</th>
                        </tr>
                    </thead>
                    <tbody id="companyBody"></tbody>
                </table>

                <!-- Detail Panel -->
                <div id="detailPanel" class="detail-panel hidden">
                    <div class="detail-header">
                        <h2 id="detailName"></h2>
                        <button class="close-btn" onclick="closeDetail()">&times;</button>
                    </div>
                    <div id="detailContent"></div>
                </div>
            </section>

            <!-- Taxonomy Tab -->
            <section id="tab-taxonomy" class="tab-content" role="tabpanel" aria-label="Taxonomy">
                <!-- Analytics Dashboard -->
                <div class="analytics-dashboard">
                    <h3 class="collapsible-header" onclick="toggleSection('analyticsSection')">
                        Analytics Dashboard <span id="analyticsSection-toggle" class="collapse-arrow">&#9660;</span>
                    </h3>
                    <div id="analyticsSection" class="collapsible-body">
                        <div class="chart-grid">
                            <div class="chart-card">
                                <h4>Companies by Category</h4>
                                <div id="chartCategoryDist" class="chart-container"></div>
                            </div>
                            <div class="chart-card">
                                <h4>Funding Stage Distribution</h4>
                                <canvas id="chartFundingStage" height="250"></canvas>
                            </div>
                            <div class="chart-card">
                                <h4>Geographic Distribution</h4>
                                <div id="chartGeoDist" class="chart-container"></div>
                            </div>
                            <div class="chart-card">
                                <h4>Confidence Scores</h4>
                                <canvas id="chartConfidence" height="250"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Taxonomy View Toggle -->
                <div class="taxonomy-view-toggle">
                    <button class="view-toggle-btn active" onclick="switchTaxonomyView('tree')" id="treeViewBtn">Tree View</button>
                    <button class="view-toggle-btn" onclick="switchTaxonomyView('graph')" id="graphViewBtn">Graph View</button>
                </div>
                <div id="taxonomyTree"></div>
                <div id="taxonomyGraph" class="hidden graph-container"></div>

                <div class="review-section">
                    <h3>Taxonomy Review</h3>
                    <p class="hint-text">Run a comprehensive AI review of all categories and company placements. Add your own observations to guide the review.</p>
                    <textarea id="reviewObservations" rows="3" class="review-textarea" placeholder="Add your observations to guide the review, e.g. 'Extend taxonomy with EAP section', 'Too many companies in Diagnostics', 'Consider splitting Wellness into Physical and Mental'..."></textarea>
                    <div class="flex-gap-sm">
                        {{ model_select('reviewModelSelect') }}
                        <button class="btn" id="reviewBtn" onclick="startTaxonomyReview()">Review Taxonomy with AI</button>
                    </div>
                    <div id="reviewStatus" class="hidden"></div>
                    <div id="reviewResults" class="hidden"></div>
                </div>

                <h3 class="collapsible-header" onclick="toggleSection('qualitySection')">
                    Quality Dashboard <span id="qualitySection-toggle" class="collapse-arrow">&#9660;</span>
                </h3>
                <div id="qualitySection" class="collapsible-body">
                    <div id="qualityDashboard" class="quality-dashboard">
                        <button class="btn" onclick="loadTaxonomyQuality()">Refresh Quality Metrics</button>
                        <div id="qualityContent" class="hidden"></div>
                    </div>
                </div>

                <h3 class="collapsible-header" onclick="toggleSection('historySection')">
                    Change History <span id="historySection-toggle" class="collapse-arrow">&#9660;</span>
                </h3>
                <div id="historySection" class="collapsible-body">
                    <div id="taxonomyHistory"></div>
                </div>
            </section>

            <!-- Map Tab -->
            <section id="tab-map" class="tab-content" role="tabpanel" aria-label="Map">
                <div class="map-controls">
                    <div class="map-view-toggle">
                        <button class="view-toggle-btn active" onclick="switchMapView('market')" id="marketMapBtn">Market Map</button>
                        <button class="view-toggle-btn" onclick="switchMapView('geo')" id="geoMapBtn">Geographic Map</button>
                    </div>
                    <button class="primary-btn" onclick="loadMarketMap()">Refresh Map</button>
                    <button class="btn" onclick="exportMapPng()">Export as PNG</button>
                    <span class="hint-text hint-inline">Drag companies between categories to reclassify.</span>
                </div>
                <div id="marketMap" class="market-map"></div>
                <div id="geoMap" class="hidden geo-map-container"></div>

                <!-- Comparison Panel -->
                <div id="compareSection" class="hidden">
                    <div class="compare-header">
                        <h3>Compare Companies</h3>
                        <button class="close-btn" onclick="clearComparison()">&times;</button>
                    </div>
                    <div id="compareContent"></div>
                </div>

                <div class="compare-bar hidden" id="compareBar">
                    <span id="compareCount">0 selected</span>
                    <button class="primary-btn" onclick="runComparison()">Compare</button>
                    <button class="btn" onclick="clearCompareSelection()">Clear</button>
                </div>
            </section>

            <!-- Reports Tab -->
            <section id="tab-reports" class="tab-content" role="tabpanel" aria-label="Reports">
                <div class="market-report-section">
                    <h3>Generate New Report</h3>
                    <p class="hint-text">Generate AI-powered market analysis for a category. Reports are saved automatically.</p>
                    <div class="report-controls">
                        <select id="reportCategorySelect">
                            <option value="">Select a category...</option>
                        </select>
                        {{ model_select('reportModelSelect', default='sonnet') }}
                        <button class="primary-btn" id="reportBtn" onclick="generateMarketReport()">Generate Report</button>
                    </div>
                    <div id="reportStatus" class="hidden">
                        <div class="progress-bar"><div id="reportProgress" class="progress-fill" style="width:50%;animation:pulse 2s infinite"></div></div>
                        <p>Generating report... AI is researching the web and analyzing your data. This typically takes 2-4 minutes.</p>
                    </div>
                </div>

                <div id="reportContent" class="hidden report-viewer"></div>

                <h3 class="section-heading">Saved Reports</h3>
                <p class="hint-text">Previously generated reports are stored here.</p>
                <div id="savedReportsList"></div>
            </section>

            <!-- Process Tab -->
            <section id="tab-process" class="tab-content" role="tabpanel" aria-label="Process">
                <!-- AI Discovery -->
                <div class="ai-discovery-section">
                    <h3>AI Company Discovery</h3>
                    <p class="hint-text">Describe a market segment and AI will search for relevant companies.</p>
                    <div class="discovery-input">
                        <input type="text" id="discoveryQuery" placeholder="e.g. gut microbiome testing companies, digital therapeutics for mental health...">
                        {{ model_select('discoveryModelSelect') }}
                        <button class="primary-btn" id="discoveryBtn" onclick="startDiscovery()">Discover</button>
                    </div>
                    <div id="discoveryResults" class="hidden">
                        <div id="discoveryStatus" class="hidden">
                            <div class="progress-bar"><div id="discoveryProgress" class="progress-fill" style="width:50%;animation:pulse 2s infinite"></div></div>
                            <p>Searching for companies...</p>
                        </div>
                        <div id="discoveryList"></div>
                    </div>
                </div>

                <div class="process-input">
                    <h3>Submit URLs for Processing</h3>
                    <textarea id="urlInput" rows="8" placeholder="Paste URLs here (one per line, or mixed with other text)..."></textarea>
                    <div class="process-options">
                        <label>Model: {{ model_select('modelSelect', include_gemini=false) }}</label>
                        <label title="Number of URLs to research simultaneously. Higher = faster but uses more API calls in parallel.">Parallel:
                            <select id="workerCount">
                                <option value="3">3 (conservative)</option>
                                <option value="5" selected>5 (balanced)</option>
                                <option value="8">8 (fast)</option>
                                <option value="10">10 (max speed)</option>
                            </select>
                        </label>
                        <button class="primary-btn" onclick="submitUrls()">Start Processing</button>
                    </div>
                </div>

                <!-- Triage Results -->
                <div id="triageSection" class="hidden">
                    <h3>Pre-Validation Triage <span id="triageStatus" class="triage-status-badge"></span></h3>
                    <p class="triage-info">Links are being checked for accessibility and relevance. Review flagged items below before processing.</p>

                    <div class="progress-bar">
                        <div id="triageProgress" class="progress-fill"></div>
                    </div>
                    <p id="triageProgressText"></p>

                    <div id="triageResults"></div>

                    <div id="triageActions" class="hidden">
                        <div class="triage-action-bar">
                            <span id="triageSummaryText"></span>
                            <button class="primary-btn" onclick="confirmAndProcess()">Confirm &amp; Process</button>
                            <button class="btn" onclick="resetTriage()">Cancel</button>
                        </div>
                    </div>
                </div>

                <!-- Processing Status -->
                <div id="processingStatus" class="hidden">
                    <div class="flex-between" style="align-items:center">
                        <h3>Processing Batch: <span id="batchId"></span></h3>
                        <button class="btn btn-sm" onclick="cancelBatchPolling()" title="Stop watching (batch continues on server)">Cancel Watch</button>
                    </div>
                    <div class="progress-bar">
                        <div id="processProgress" class="progress-fill"></div>
                    </div>
                    <p id="processStatus"></p>
                </div>

                <h3>Recent Batches</h3>
                <p class="hint-text">Click a batch to see full details.</p>
                <div id="batchList"></div>
                <div id="batchDetailView" class="hidden"></div>
            </section>

            <!-- Export Tab -->
            <section id="tab-export" class="tab-content" role="tabpanel" aria-label="Export">
                <div class="export-options">
                    <div class="export-card">
                        <h3>JSON</h3>
                        <p>Full structured data for programmatic use</p>
                        <a id="exportJson" href="/api/export/json" class="btn">Download JSON</a>
                    </div>
                    <div class="export-card">
                        <h3>Markdown</h3>
                        <p>LLM-optimized taxonomy for Claude / FigJam</p>
                        <a id="exportMd" href="/api/export/md" class="btn">Download Markdown</a>
                    </div>
                    <div class="export-card">
                        <h3>CSV</h3>
                        <p>Spreadsheet-compatible format</p>
                        <a id="exportCsv" href="/api/export/csv" class="btn">Download CSV</a>
                    </div>
                    <div class="export-card">
                        <h3>Excel (.xlsx)</h3>
                        <p>Formatted workbook with sheets per category</p>
                        <button class="btn" onclick="exportXlsx()">Download Excel</button>
                    </div>
                    <div class="export-card">
                        <h3>PDF Report</h3>
                        <p>Professional PDF with charts and data tables</p>
                        <button class="btn" onclick="exportFullPdf()">Download PDF</button>
                    </div>
                </div>

                <h3 class="section-heading">Share Project</h3>
                <div class="share-section">
                    <p class="hint-text">Generate a read-only share link for external stakeholders.</p>
                    <div class="share-controls">
                        <input type="text" id="shareLinkLabel" placeholder="Link label (e.g. 'For investors')">
                        <button class="primary-btn" onclick="createShareLink()">Generate Link</button>
                    </div>
                    <div id="shareTokensList"></div>
                </div>

                <h3 class="section-heading">Notification Settings</h3>
                <div class="notification-settings">
                    <p class="hint-text">Configure alerts for project events.</p>
                    <div class="notif-field">
                        <label for="slackWebhook">Slack Webhook URL</label>
                        <div class="flex-gap-xs">
                            <input type="url" id="slackWebhook" placeholder="https://hooks.slack.com/services/...">
                            <button class="btn" onclick="testSlack()">Test</button>
                        </div>
                    </div>
                    <div class="notif-checkboxes">
                        <label><input type="checkbox" id="notifBatchComplete" checked> Notify on batch complete</label>
                        <label><input type="checkbox" id="notifTaxonomyChange" checked> Notify on taxonomy changes</label>
                        <label><input type="checkbox" id="notifNewCompany"> Notify on new companies</label>
                    </div>
                    <button class="primary-btn" onclick="saveNotifPrefs()">Save Preferences</button>
                    <div id="notifSaveResult" class="hidden"></div>
                </div>

                <h3 class="section-heading">Import CSV</h3>
                <div class="import-section">
                    <p class="hint-text">Upload a CSV file with columns: name, url, what, target, products, funding, geography, tam, tags, etc.</p>
                    <form id="csvImportForm" onsubmit="importCsv(event)">
                        <input type="file" id="csvFile" accept=".csv" required>
                        <button type="submit" class="primary-btn">Import</button>
                    </form>
                    <div id="importResult" class="hidden"></div>
                </div>

                <h3 class="section-heading">Trash</h3>
                <p class="hint-text">Deleted companies can be restored or permanently removed.</p>
                <button class="btn" onclick="loadTrash()">View Trash</button>
                <div id="trashList" class="hidden"></div>

                <h3 class="section-heading">Duplicates</h3>
                <p class="hint-text">Find potential duplicate companies by URL.</p>
                <button class="btn" onclick="findDuplicates()">Scan for Duplicates</button>
                <div id="duplicatesList" class="hidden"></div>

                <h3 class="section-heading">Activity Log</h3>
                <p class="hint-text">Recent project activity and changes.</p>
                <button class="btn" onclick="loadActivity()">Load Activity</button>
                <div id="activityFeed" class="hidden"></div>
            </section>
        </div>
    </div>

    <!-- AI Chat Widget -->
    <div id="chatWidget" class="chat-widget hidden" role="complementary" aria-label="AI Chat">
        <div class="chat-header" onclick="toggleChat()">
            <span>Ask about your data</span>
            <button class="chat-close" onclick="event.stopPropagation();closeChat()" aria-label="Close chat">&times;</button>
        </div>
        <div class="chat-body" id="chatBody">
            <div class="chat-welcome">Ask questions about your taxonomy data. e.g. "Which companies focus on employer wellness?"</div>
        </div>
        <div class="chat-input-row">
            <input type="text" id="chatInput" placeholder="Ask a question..." onkeydown="if(event.key==='Enter')sendChatMessage()">
            <button class="primary-btn" onclick="sendChatMessage()">Send</button>
        </div>
    </div>
    <button id="chatToggle" class="chat-fab hidden" onclick="toggleChat()" title="AI Chat">&#128172;</button>
    <button id="tourBtn" class="tour-fab hidden" onclick="startProductTour()" title="Product Tour">?</button>

    <!-- Edit Modal -->
    <div id="editModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="editModalTitle">
        <div class="modal">
            <div class="modal-header">
                <h2 id="editModalTitle">Edit Company</h2>
                <button class="close-btn" onclick="closeEditModal()" aria-label="Close edit modal">&times;</button>
            </div>
            <form id="editForm" onsubmit="saveEdit(event)">
                <input type="hidden" id="editId">
                <div class="form-grid">
                    <div class="form-group full-width">
                        <label for="editName">Name</label>
                        <input type="text" id="editName" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="editUrl">URL</label>
                        <input type="url" id="editUrl" required>
                    </div>
                    <div class="form-group full-width">
                        <label for="editWhat">What they do</label>
                        <textarea id="editWhat" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editTarget">Target</label>
                        <input type="text" id="editTarget">
                    </div>
                    <div class="form-group">
                        <label for="editGeography">Geography</label>
                        <input type="text" id="editGeography">
                    </div>
                    <div class="form-group full-width">
                        <label for="editProducts">Products</label>
                        <textarea id="editProducts" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="editFunding">Funding</label>
                        <input type="text" id="editFunding">
                    </div>
                    <div class="form-group">
                        <label for="editTam">TAM</label>
                        <input type="text" id="editTam">
                    </div>
                    <div class="form-group">
                        <label for="editEmployeeRange">Employee Range</label>
                        <select id="editEmployeeRange">
                            <option value="">-- Select --</option>
                            <option value="1-10">1-10</option>
                            <option value="11-50">11-50</option>
                            <option value="51-200">51-200</option>
                            <option value="201-500">201-500</option>
                            <option value="501-1000">501-1000</option>
                            <option value="1000+">1000+</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editFoundedYear">Founded Year</label>
                        <input type="number" id="editFoundedYear" min="1900" max="2030">
                    </div>
                    <div class="form-group">
                        <label for="editFundingStage">Funding Stage</label>
                        <select id="editFundingStage">
                            <option value="">-- Select --</option>
                            <option value="Pre-Seed">Pre-Seed</option>
                            <option value="Seed">Seed</option>
                            <option value="Series A">Series A</option>
                            <option value="Series B">Series B</option>
                            <option value="Series C+">Series C+</option>
                            <option value="Public">Public</option>
                            <option value="Bootstrapped">Bootstrapped</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editTotalFunding">Total Funding (USD)</label>
                        <input type="number" id="editTotalFunding" min="0" step="1">
                    </div>
                    <div class="form-group">
                        <label for="editHqCity">HQ City</label>
                        <input type="text" id="editHqCity">
                    </div>
                    <div class="form-group">
                        <label for="editHqCountry">HQ Country</label>
                        <input type="text" id="editHqCountry">
                    </div>
                    <div class="form-group full-width">
                        <label for="editLinkedin">LinkedIn URL</label>
                        <input type="url" id="editLinkedin" placeholder="https://linkedin.com/company/...">
                    </div>
                    <div class="form-group">
                        <label for="editCategory">Category</label>
                        <select id="editCategory" onchange="loadSubcategories()">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editSubcategory">Subcategory</label>
                        <select id="editSubcategory">
                            <option value="">-- Select --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editBusinessModel">Business Model</label>
                        <select id="editBusinessModel">
                            <option value="">-- Select --</option>
                            <option value="B2B">B2B</option>
                            <option value="B2C">B2C</option>
                            <option value="B2B2C">B2B2C</option>
                            <option value="D2C">D2C</option>
                            <option value="Marketplace">Marketplace</option>
                            <option value="Platform">Platform</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editCompanyStage">Company Stage</label>
                        <select id="editCompanyStage">
                            <option value="">-- Select --</option>
                            <option value="Pre-launch">Pre-launch</option>
                            <option value="Early">Early</option>
                            <option value="Growth">Growth</option>
                            <option value="Mature">Mature</option>
                            <option value="Public">Public</option>
                        </select>
                    </div>
                    <div class="form-group full-width">
                        <label for="editPrimaryFocus">Primary Focus</label>
                        <input type="text" id="editPrimaryFocus" placeholder="e.g. mental health, diagnostics, telehealth">
                    </div>
                    <div class="form-group full-width">
                        <label for="editTags">Tags (comma-separated)</label>
                        <input type="text" id="editTags" placeholder="e.g. competitor, B2B, wearable">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="primary-btn">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tag Management Modal -->
    <div id="tagModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="tagModalTitle">
        <div class="modal modal-narrow">
            <div class="modal-header">
                <h2 id="tagModalTitle">Manage Tags</h2>
                <button class="close-btn" onclick="closeTagManager()" aria-label="Close tag manager">&times;</button>
            </div>
            <div id="tagManagerContent">
                <div class="tag-manager-actions">
                    <button class="btn" onclick="showTagRenameForm()">Rename Tag</button>
                    <button class="btn" onclick="showTagMergeForm()">Merge Tags</button>
                </div>
                <div id="tagRenameForm" class="tag-action-form hidden">
                    <input type="text" id="tagRenameOld" placeholder="Current tag name">
                    <input type="text" id="tagRenameNew" placeholder="New tag name">
                    <button class="primary-btn" onclick="executeTagRename()">Rename</button>
                    <button class="btn" onclick="hideTagForms()">Cancel</button>
                </div>
                <div id="tagMergeForm" class="tag-action-form hidden">
                    <input type="text" id="tagMergeSource" placeholder="Tag to merge (will be removed)">
                    <input type="text" id="tagMergeTarget" placeholder="Merge into this tag">
                    <button class="primary-btn" onclick="executeTagMerge()">Merge</button>
                    <button class="btn" onclick="hideTagForms()">Cancel</button>
                </div>
                <div id="tagList" class="tag-list"></div>
            </div>
        </div>
    </div>

    <!-- App JS modules (load order matters: core first, integrations/init last) -->
    <script src="{{ url_for('static', filename='js/core.js') }}"></script>
    <script src="{{ url_for('static', filename='js/projects.js') }}"></script>
    <script src="{{ url_for('static', filename='js/companies.js') }}"></script>
    <script src="{{ url_for('static', filename='js/taxonomy.js') }}"></script>
    <script src="{{ url_for('static', filename='js/maps.js') }}"></script>
    <script src="{{ url_for('static', filename='js/processing.js') }}"></script>
    <script src="{{ url_for('static', filename='js/filters.js') }}"></script>
    <script src="{{ url_for('static', filename='js/tags.js') }}"></script>
    <script src="{{ url_for('static', filename='js/reports.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ai.js') }}"></script>
    <script src="{{ url_for('static', filename='js/export.js') }}"></script>
    <script src="{{ url_for('static', filename='js/settings.js') }}"></script>
    <script src="{{ url_for('static', filename='js/keyboard.js') }}"></script>
    <script src="{{ url_for('static', filename='js/sse.js') }}"></script>
    <script src="{{ url_for('static', filename='js/charts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/integrations.js') }}"></script>
    <script src="{{ url_for('static', filename='js/init.js') }}"></script>
</body>
</html>
